<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- base data saved from url=(0046)http://tespedia.ru/special/skyrim_alchemy_tool -->
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" id="js">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Калькулятор Алхимии для Скайрима</title>

<style type="text/css">
body{
	border:none;
	line-height:1.6em;
	width:100%;
	height:100%;
	font-family:Arial, Tahoma, sans-serif;
	font-size:12px;
	color:#4a4a4a;
	background-color:#89A;
}

a{
	font-size:12px;
	/*color:#1F68A2;*/
	text-decoration:none;
}
a:hover{
	text-decoration:underline;
}
a img{
	border:none;
}
a, a:hover, a:visited{
	/*color:#1F68A2;*/
	color:#444;
}

h1, h2, h3, h4{
	color:#AF9F89;
	font-family: Arial;
	font-style:italic;
}

h1{
	margin:0px 0px 20px 0px;
	font-size:2em;
	line-height:24px;
	border-bottom:1px solid #dae1e8;
	padding:0px 0px 1px 3px;
	width:100%;
}

h2{
	font-size: 19px;
	border-bottom:1px solid #dae1e8;
	padding:0px 0px 1px 0px;
	margin:0px 0px 12px 0px;
	overflow:hidden;
}
h2 a{ font-size: 19px; }

h3{
	font-size:15px;
	line-height:normal;
	margin: 0px 0px 8px 0px;
	font-weight:bold;
	padding:0px;
	overflow:hidden;
}
h3 a{ font-size: 15px; }
h2 a, h3 a, h2 a:hover, h3:hover a{text-decoration:none;}

a h2, a h2, a h3, a h4{
	/*color:#1F68A2;*/
	text-decoration:none;
}

label { cursor:pointer; }
</style>

<style type="text/css">
html{ width:100%;}
html,body{
	height:100%;
	margin:0px;padding:0px;background: #6a7f94;
	background: -moz-linear-gradient(top,#6a7f94 0,#CDD5DC 500px);
	background: -webkit-linear-gradient(#6a7f94 0,#CDD5DC 500px);
	background: -ms-linear-gradient(top,#6a7f94 0,#CDD5DC 500px);
	background: linear-gradient(top,#6a7f94 0,#CDD5DC 500px);
	background-color: #CDD5DC;
	background-repeat: no-repeat;margin: 0;
}
div#wrapper {min-width:1005px; max-width:1280px; margin:auto;}
/*div#wrapper {border-left:1px solid #666; border-right:1px solid #666; border-bottom:1px solid #666; box-shadow: 0 0 8px rgba(0,0,0,0.7);}*/
#maincolumn {width:100%; position:relative; text-align:left; margin-bottom:30px; padding:0px; min-height:400px;}
#area {position:relative; background:#fff; padding:0; overflow:hidden; z-index:100; padding:170px 0px 15px 0px;}
#wrapper_r {position:relative;}

th.EffectNeg, td.EffectNeg {background-color: #FDD !important;}
th.EffectPos, td.EffectPos {background-color: #DFD !important;}
table#ingredients_table tbody td>a, #ingredient_filter table tbody td>a, #ingredient_name_div table tbody td>a {
	display: block;
	float: left;
	white-space: nowrap;
	overflow:hidden;
}

th.name_column {width: 15em;}
#alch_div table td.name_column>a {width: 11em;}
#alch_div .EditFilterMode table td.name_column>a {width: 9em;}
#alch_div table td.name_column input[type=checkbox] {float:left;}
th.effect_column {width: 20em;}
#alch_div table td.EffectNeg>a, #alch_div table td.EffectPos>a {width: 15.5em;}

th.num_column, td.num_column {width: 2em; text-align: center;}

#alch_div table td {position: relative;}
.diveye {position: absolute; top: 8px; right: 8px; height: 20px;}
.diveye img {position: relative; top: -2px;}
.effectvprice {position: absolute; bottom: 1px; right: 1px; width: 2px; background-color: #EAAF00;}

.effect_warning a {color:#FF0080;}
td.best_price, .best_price a {color:#aaa; font-size:11px; cursor:pointer}

#filter_div {margin: 15px 0 10px 0;}
.highlighted {font-weight: bolder;}
#alch_div table td a.highlighted {color: #8000FF;}
#filter_div p, #potions_div p, #effects_filter a, #filtered_div p {font-size: medium;}

table.tablesorter thead tr .header {
	background-image: url(header_bg.gif);
	background-repeat: no-repeat;
	background-position: center right;
	cursor: pointer;
}
table.tablesorter thead tr .headerSortUp {
	background-image: url(header_asc.gif);
}
table.tablesorter thead tr .headerSortDown {
	background-image: url(header_desc.gif);
}
#alch_div table th{ background:#555; color:#eee; }
#alch_div table td, #alch_div table th{
	padding:8px !important;
	font-size:11px;
	text-align:left;
	border:1px solid #ccc;
}
#alch_div table{
	border-collapse:collapse;
	background:#f0f0f0;
}
#alch_div table td.filtered, #alch_div table td.filtered a{
	color:#aaa;
}
table#ingredients_table tr.filtered, table#ingredients_table tr.unusable {display:none;}

input.abutton {height:auto; padding:7px 10px; background:#444; color:#eee; border-radius:10px; cursor:pointer;}
input.abutton:disabled {background:#777;color:#ccc;}
input[type=checkbox] {vertical-align: middle;}

#filtered_div table td {padding:0 !important; font-size:12px;}
.filterBox {border:1px solid #ccc; padding:5px; margin:2px; display:inline-block}
.filterBox input[type=checkbox] {margin: 0 3px 0 0;}

.pointer, #alch_div a, #help_info a {cursor:pointer;}

#loading {margin: 30px 30px 30px 0; border:1px solid #eee; padding: 5px}
#progress_bar {background-color:#FFFFCC; border:1px solid #ccc; height: 15px; width: 100%}

#help_info {background-color: #CDD5DC; margin:10px 0; padding:5px;}
</style>

<script type="text/javascript" src="./files/jquery.min.js"></script>
<script type="text/javascript" src="./files/jquery.tablesorter.min.js"></script>

<script type="text/javascript">
var filteredDefault = [19,24,26,33,38,63,64];
var filteredIngredients = filteredDefault;

// filtered check
function isFilteredIngredient(id) {
	return $.inArray(parseInt(id), filteredIngredients) > -1;
}

var effectsWarning = [
"Повышение навыка: Зачарование",
"Повышение навыка: Кузнечное дело",
]

var effectsPositive = {
"Исцеление болезней":true,
"Урон здоровью":false,
"Урон магии":false,
"Повреждение регенерации магии":false,
"Урон запасу сил":false,
"Повреждение регенерации запаса сил":false,
"Страх":false,
"Повышение навыка: Изменение":true,
"Повышение искусства торговли":true,
"Повышение навыка: Блокирование":true,
"Повышение переносимого веса":true,
"Повышение навыка: Колдовство":true,
"Повышение навыка: Разрушение":true,
"Повышение навыка: Зачарование":true,
"Повышение здоровья":true,
"Повышение навыка: Тяжелая броня":true,
"Повышение навыка: Иллюзия":true,
"Повышение навыка: Легкая броня":true,
"Повышение навыка: Взлом":true,
"Повышение магии":true,
"Повышение искусства лучника":true,
"Повышение навыка: Одноручное оружие":true,
"Повышение навыка: Карманные кражи":true,
"Повышение навыка: Восстановление":true,
"Повышение навыка: Кузнечное дело":true,
"Повышение навыка: Скрытность":true,
"Повышение запаса сил":true,
"Повышение навыка: Двуручное оружие":true,
"Бешенство":false,
"Невидимость":true,
"Затяжной урон здоровью":false,
"Затяжной урон магии":false,
"Затяжной урон запасу сил":false,
"Паралич":false,
"Опустошение здоровья":false,
"Опустошение магии":false,
"Опустошение запаса сил":false,
"Регенерация здоровья":true,
"Регенерация магии":true,
"Регенерация запаса сил":true,
"Сопротивление огню":true,
"Сопротивление холоду":true,
"Сопротивление магии":true,
"Сопротивление ядам":true,
"Сопротивление электричеству":true,
"Восстановление здоровья":true,
"Восстановление магии":true,
"Восстановление запаса сил":true,
"Замедление":false,
"Водное дыхание":true,
"Уязвимость к огню":false,
"Уязвимость к холоду":false,
"Уязвимость к магии":false,
"Уязвимость к яду":false,
"Уязвимость к электричеству":false,
}

var effectsPrice = {
"Исцеление болезней":7,
"Урон здоровью":3,
"Урон магии":52,
"Повреждение регенерации магии":265,
"Урон запасу сил":43,
"Повреждение регенерации запаса сил":159,
"Страх":120,
"Повышение навыка: Изменение":47,
"Повышение искусства торговли":48,
"Повышение навыка: Блокирование":118,
"Повышение переносимого веса":208,
"Повышение навыка: Колдовство":75,
"Повышение навыка: Разрушение":151,
"Повышение навыка: Зачарование":14,
"Повышение здоровья":82,
"Повышение навыка: Тяжелая броня":55,
"Повышение навыка: Иллюзия":94,
"Повышение навыка: Легкая броня":55,
"Повышение навыка: Взлом":25,
"Повышение магии":71,
"Повышение искусства лучника":118,
"Повышение навыка: Одноручное оружие":118,
"Повышение навыка: Карманные кражи":118,
"Повышение навыка: Восстановление":118,
"Повышение навыка: Кузнечное дело":82,
"Повышение навыка: Скрытность":118,
"Повышение запаса сил":71,
"Повышение навыка: Двуручное оружие":118,
"Бешенство":107,
"Невидимость":261,
"Затяжной урон здоровью":86,
"Затяжной урон магии":71,
"Затяжной урон запасу сил":12,
"Паралич":285,
"Опустошение здоровья":6,
"Опустошение магии":15,
"Опустошение запаса сил":24,
"Регенерация здоровья":177,
"Регенерация магии":177,
"Регенерация запаса сил":177,
"Сопротивление огню":86,
"Сопротивление холоду":86,
"Сопротивление магии":51,
"Сопротивление ядам":118,
"Сопротивление электричеству":86,
"Восстановление здоровья":21,
"Восстановление магии":25,
"Восстановление запаса сил":25,
"Замедление":247,
"Водное дыхание":100,
"Уязвимость к огню":48,
"Уязвимость к холоду":40,
"Уязвимость к магии":51,
"Уязвимость к яду":51,
"Уязвимость к электричеству":56,
}

// calc max price
var maxEPrice = 0;
for (var i in effectsPrice)
	if (maxEPrice < effectsPrice[i])
		maxEPrice = effectsPrice[i];

// calc sum price of effects
function calcEPrice(effects) {
	var deltaPN = 80/100;
	var priceP = 0;
	var priceN = 0;
	for (var i in effects)
		if (effectsPositive[effects[i]])
			priceP += effectsPrice[effects[i]];
		else
			priceN += effectsPrice[effects[i]];
	return Math.round( priceP < priceN ? priceN + priceP*deltaPN : priceP + priceN*deltaPN );
}
</script>

<script type="text/javascript">
var ingredientsList = {
1:{ingredient:"Абесинский окунь", effects:["Уязвимость к холоду", "Повышение навыка: Скрытность", "Уязвимость к яду", "Повышение навыка: Восстановление"], weight:"0.5", price:"15"},
2:{ingredient:"Алый корень Нирна", effects:["Урон здоровью", "Урон запасу сил", "Невидимость", "Сопротивление магии"], weight:"0.2", price:"10"},
3:{ingredient:"Белянка", effects:["Уязвимость к холоду", "Повышение навыка: Тяжелая броня", "Восстановление магии", "Опустошение магии"], weight:"0.3", price:"0"},
4:{ingredient:"Бесовский гриб", effects:["Урон здоровью", "Затяжной урон здоровью", "Паралич", "Восстановление здоровья"], weight:"0.3", price:"0"},
5:{ingredient:"Бойцовая рыбка", effects:["Урон здоровью", "Повышение навыка: Изменение", "Замедление", "Повышение переносимого веса"], weight:"0.25", price:"15"},
6:{ingredient:"Болотный стручок", effects:["Сопротивление электричеству", "Затяжной урон магии", "Паралич", "Восстановление здоровья"], weight:"0.25", price:"5"},
7:{ingredient:"Большие рога", effects:["Восстановление запаса сил", "Повышение запаса сил", "Замедление", "Повреждение регенерации запаса сил"], weight:"0.1", price:"2"},
8:{ingredient:"Бородатый мох", effects:["Урон магии", "Повышение здоровья", "Повреждение регенерации магии", "Повышение навыка: Одноручное оружие"], weight:"0.25", price:"1"},
9:{ingredient:"Вересковое сердце", effects:["Восстановление магии", "Повышение навыка: Блокирование", "Паралич", "Повышение магии"], weight:"0.5", price:"20"},
10:{ingredient:"Ветка чертополоха", effects:["Сопротивление холоду", "Опустошение запаса сил", "Сопротивление ядам", "Повышение навыка: Тяжелая броня"], weight:"0.1", price:"1"},
11:{ingredient:"Виноград джазби", effects:["Уязвимость к магии", "Повышение магии", "Регенерация магии", "Опустошение здоровья"], weight:"0.2", price:"1"},
12:{ingredient:"Гигантский лишайник", effects:["Уязвимость к электричеству", "Опустошение здоровья", "Уязвимость к яду", "Восстановление магии"], weight:"0.25", price:"5"},
13:{ingredient:"Глаз саблезуба", effects:["Восстановление запаса сил", "Опустошение здоровья", "Урон магии", "Восстановление здоровья"], weight:"0.1", price:"2"},
14:{ingredient:"Гниль Намиры", effects:["Урон магии", "Повышение навыка: Взлом", "Страх", "Регенерация здоровья"], weight:"0.25", price:"0"},
15:{ingredient:"Голубой горноцвет", effects:["Восстановление здоровья", "Повышение навыка: Колдовство", "Повышение здоровья", "Повреждение регенерации магии"], weight:"0.1", price:"2"},
16:{ingredient:"Двемерское масло", effects:["Уязвимость к магии", "Повышение навыка: Иллюзия", "Регенерация магии", "Восстановление магии"], weight:"0.25", price:"15"},
17:{ingredient:"Жареная злокрысья кожа", effects:["Восстановление запаса сил", "Исцеление болезней", "Сопротивление ядам", "Восстановление здоровья"], weight:"0.5", price:"1"},
18:{ingredient:"Жемчужина", effects:["Восстановление запаса сил", "Повышение навыка: Блокирование", "Восстановление магии", "Сопротивление электричеству"], weight:"0.1", price:"2"},
19:{ingredient:"Живица сприггана", effects:["Повреждение регенерации магии", "Повышение навыка: Зачарование", "Повышение навыка: Кузнечное дело", "Повышение навыка: Изменение"], weight:"0.2", price:"15"},
20:{ingredient:"Жир тролля", effects:["Сопротивление ядам", "Повышение навыка: Двуручное оружие", "Бешенство", "Урон здоровью"], weight:"1", price:"15"},
21:{ingredient:"Зубы ледяного привидения", effects:["Уязвимость к холоду", "Повышение навыка: Тяжелая броня", "Невидимость", "Уязвимость к огню"], weight:"0.25", price:"30"},
22:{ingredient:"Икра рыбы-убийцы", effects:["Сопротивление ядам", "Повышение навыка: Карманные кражи", "Затяжной урон здоровью", "Повышение запаса сил"], weight:"0.2", price:"3"},
23:{ingredient:"Клешня грязевого краба", effects:["Восстановление запаса сил", "Исцеление болезней", "Сопротивление ядам", "Сопротивление огню"], weight:"0.25", price:"2"},
24:{ingredient:"Клык саблезуба", effects:["Восстановление запаса сил", "Повышение навыка: Тяжелая броня", "Повышение навыка: Кузнечное дело", "Уязвимость к яду"], weight:"0.1", price:"2"},
25:{ingredient:"Клюв ястреба", effects:["Восстановление запаса сил", "Сопротивление холоду", "Повышение переносимого веса", "Сопротивление электричеству"], weight:"0.25", price:"15"},
26:{ingredient:"Коготь ворожеи", effects:["Сопротивление магии", "Затяжной урон магии", "Повышение навыка: Зачарование", "Повышение искусства торговли"], weight:"0.25", price:"20"},
27:{ingredient:"Корень Нирна", effects:["Урон здоровью", "Урон запасу сил", "Невидимость", "Сопротивление магии"], weight:"0.2", price:"10"},
28:{ingredient:"Костная мука", effects:["Урон запасу сил", "Сопротивление огню", "Повышение навыка: Колдовство", "Опустошение запаса сил"], weight:"0.5", price:"5"},
29:{ingredient:"Красный горноцвет", effects:["Восстановление магии", "Опустошение магии", "Повышение магии", "Урон здоровью"], weight:"0.1", price:"2"},
30:{ingredient:"Кровавый венец", effects:["Уязвимость к огню", "Повышение навыка: Блокирование", "Уязвимость к яду", "Сопротивление магии"], weight:"0.3", price:"10"},
31:{ingredient:"Крыло лунного мотылька", effects:["Урон магии", "Повышение навыка: Легкая броня", "Регенерация здоровья", "Невидимость"], weight:"0.1", price:"5"},
32:{ingredient:"Крыло монарха", effects:["Восстановление здоровья", "Повышение искусства торговли", "Затяжной урон запасу сил", "Урон магии"], weight:"0.1", price:"3"},
33:{ingredient:"Крыло синей бабочки", effects:["Урон запасу сил", "Повышение навыка: Колдовство", "Повреждение регенерации магии", "Повышение навыка: Зачарование"], weight:"0.1", price:"2"},
34:{ingredient:"Куриное яйцо", effects:["Сопротивление магии", "Повреждение регенерации магии", "Водное дыхание", "Затяжной урон запасу сил"], weight:"0.5", price:"2"},
35:{ingredient:"Лаванда", effects:["Сопротивление магии", "Повышение запаса сил", "Опустошение магии", "Повышение навыка: Колдовство"], weight:"0.1", price:"1"},
36:{ingredient:"Лиловый горноцвет", effects:["Восстановление запаса сил", "Повышение навыка: Скрытность", "Затяжной урон магии", "Сопротивление холоду"], weight:"0.1", price:"2"},
37:{ingredient:"Лунный сахар", effects:["Уязвимость к огню", "Сопротивление холоду", "Восстановление магии", "Регенерация магии"], weight:"0.25", price:"50"},
38:{ingredient:"Лютый гриб", effects:["Урон запасу сил", "Бешенство", "Восстановление здоровья", "Повышение навыка: Кузнечное дело"], weight:"0.2", price:"12"},
39:{ingredient:"Маленькая жемчужина", effects:["Восстановление запаса сил", "Повышение навыка: Одноручное оружие", "Повышение навыка: Восстановление", "Сопротивление холоду"], weight:"0.1", price:"2"},
40:{ingredient:"Маленькие рога", effects:["Уязвимость к яду", "Повышение навыка: Восстановление", "Затяжной урон запасу сил", "Урон здоровью"], weight:"0.1", price:"2"},
41:{ingredient:"Медвежьи когти", effects:["Восстановление запаса сил", "Повышение здоровья", "Повышение навыка: Одноручное оружие", "Повреждение регенерации магии"], weight:"0.1", price:"2"},
42:{ingredient:"Медовые соты", effects:["Восстановление запаса сил", "Повышение навыка: Блокирование", "Повышение навыка: Легкая броня", "Опустошение запаса сил"], weight:"1", price:"5"},
43:{ingredient:"Мора тапинелла", effects:["Восстановление магии", "Затяжной урон здоровью", "Регенерация запаса сил", "Повышение навыка: Иллюзия"], weight:"0.25", price:"4"},
44:{ingredient:"Морозная мириам", effects:["Сопротивление холоду", "Повышение навыка: Скрытность", "Опустошение магии", "Повреждение регенерации запаса сил"], weight:"0.1", price:"1"},
45:{ingredient:"Морозная соль", effects:["Уязвимость к огню", "Сопротивление холоду", "Восстановление магии", "Повышение навыка: Колдовство"], weight:"0.25", price:"100"},
46:{ingredient:"Морской желудь", effects:["Урон магии", "Водное дыхание", "Регенерация здоровья", "Повышение навыка: Карманные кражи"], weight:"0.2", price:"5"},
47:{ingredient:"Мухомор", effects:["Сопротивление огню", "Повышение навыка: Двуручное оружие", "Бешенство", "Регенерация запаса сил"], weight:"0.1", price:"2"},
48:{ingredient:"Огненная соль", effects:["Уязвимость к холоду", "Сопротивление огню", "Восстановление магии", "Регенерация магии"], weight:"0.25", price:"50"},
49:{ingredient:"Оранжевая стрекоза", effects:["Восстановление запаса сил", "Опустошение магии", "Повышение навыка: Карманные кражи", "Затяжной урон здоровью"], weight:"0.1", price:"1"},
50:{ingredient:"Палец великана", effects:["Урон запасу сил", "Повышение здоровья", "Повышение переносимого веса", "Повреждение регенерации запаса сил"], weight:"1", price:"20"},
51:{ingredient:"Паслен", effects:["Урон здоровью", "Повреждение регенерации магии", "Затяжной урон запасу сил", "Повышение навыка: Разрушение"], weight:"0.1", price:"8"},
52:{ingredient:"Паучье яйцо", effects:["Урон запасу сил", "Повреждение регенерации магии", "Повышение навыка: Взлом", "Повышение искусства лучника"], weight:"0.2", price:"5"},
53:{ingredient:"Пелена дымка", effects:["Восстановление запаса сил", "Повышение навыка: Разрушение", "Повышение переносимого веса", "Сопротивление магии"], weight:"0.1", price:"2"},
54:{ingredient:"Перья ворожеи", effects:["Урон магии", "Повышение навыка: Колдовство", "Бешенство", "Уязвимость к электричеству"], weight:"0.1", price:"20"},
55:{ingredient:"Перья ястреба", effects:["Исцеление болезней", "Повышение навыка: Легкая броня", "Повышение навыка: Одноручное оружие", "Повышение навыка: Скрытность"], weight:"0.1", price:"15"},
56:{ingredient:"Ползучая лоза", effects:["Восстановление магии", "Повреждение регенерации запаса сил", "Повышение переносимого веса", "Уязвимость к магии"], weight:"0.2", price:"1"},
57:{ingredient:"Прах вампира", effects:["Невидимость", "Восстановление магии", "Регенерация здоровья", "Исцеление болезней"], weight:"0.2", price:"25"},
58:{ingredient:"Пушица", effects:["Сопротивление магии", "Повышение магии", "Повышение навыка: Блокирование", "Повышение искусства торговли"], weight:"0.1", price:"1"},
59:{ingredient:"Пчела", effects:["Восстановление запаса сил", "Опустошение запаса сил", "Регенерация запаса сил", "Уязвимость к электричеству"], weight:"0.1", price:"3"},
60:{ingredient:"Пчелиное гнездо", effects:["Сопротивление ядам", "Повышение навыка: Легкая броня", "Повышение навыка: Скрытность", "Повышение навыка: Разрушение"], weight:"1", price:"5"},
61:{ingredient:"Пшеница", effects:["Восстановление здоровья", "Повышение здоровья", "Повреждение регенерации запаса сил", "Затяжной урон магии"], weight:"0.1", price:"5"},
62:{ingredient:"Светящаяся пыль", effects:["Урон магии", "Повреждение регенерации магии", "Повышение навыка: Разрушение", "Сопротивление электричеству"], weight:"0.5", price:"20"},
63:{ingredient:"Светящийся гриб", effects:["Сопротивление электричеству", "Повышение навыка: Разрушение", "Повышение навыка: Кузнечное дело", "Повышение здоровья"], weight:"0.2", price:"5"},
64:{ingredient:"Сердце даэдра", effects:["Восстановление здоровья", "Повреждение регенерации запаса сил", "Урон магии", "Страх"], weight:"0.5", price:"250"},
65:{ingredient:"Серебристый окунь", effects:["Восстановление запаса сил", "Повреждение регенерации запаса сил", "Опустошение здоровья", "Сопротивление холоду"], weight:"0.25", price:"15"},
66:{ingredient:"Синяя стрекоза", effects:["Сопротивление электричеству", "Повышение навыка: Карманные кражи", "Восстановление здоровья", "Страх"], weight:"0.1", price:"1"},
67:{ingredient:"Сиродильский лопатохвост", effects:["Урон запасу сил", "Повышение навыка: Восстановление", "Страх", "Опустошение здоровья"], weight:"0.25", price:"15"},
68:{ingredient:"Снежные ягоды", effects:["Сопротивление огню", "Повышение навыка: Зачарование", "Сопротивление холоду", "Сопротивление электричеству"], weight:"0.1", price:"4"},
69:{ingredient:"Собачий корень", effects:["Урон запасу сил", "Повышение навыка: Одноручное оружие", "Повышение искусства лучника", "Паралич"], weight:"0.1", price:"5"},
70:{ingredient:"Соль", effects:["Уязвимость к магии", "Повышение навыка: Восстановление", "Замедление", "Регенерация магии"], weight:"0.2", price:"2"},
71:{ingredient:"Соль пустоты", effects:["Уязвимость к электричеству", "Сопротивление магии", "Урон здоровью", "Повышение магии"], weight:"0.2", price:"125"},
72:{ingredient:"Стержневой корень", effects:["Уязвимость к магии", "Повышение навыка: Иллюзия", "Регенерация магии", "Восстановление магии"], weight:"0.5", price:"15"},
73:{ingredient:"Толченый бивень мамонта", effects:["Восстановление запаса сил", "Повышение навыка: Скрытность", "Уязвимость к огню", "Страх"], weight:"0.1", price:"2"},
74:{ingredient:"Торакс светлячка", effects:["Восстановление запаса сил", "Затяжной урон магии", "Уязвимость к магии", "Повышение запаса сил"], weight:"0.1", price:"1"},
75:{ingredient:"Травяной стручок", effects:["Сопротивление ядам", "Опустошение магии", "Повышение навыка: Изменение", "Восстановление магии"], weight:"0.1", price:"1"},
76:{ingredient:"Ухо фалмера", effects:["Урон здоровью", "Бешенство", "Сопротивление ядам", "Повышение навыка: Взлом"], weight:"0.2", price:"10"},
77:{ingredient:"Хвост злокрыса", effects:["Повреждение регенерации запаса сил", "Опустошение здоровья", "Урон здоровью", "Повышение навыка: Легкая броня"], weight:"0.2", price:"3"},
78:{ingredient:"Хисткарп", effects:["Восстановление запаса сил", "Повышение магии", "Повреждение регенерации запаса сил", "Водное дыхание"], weight:"0.25", price:"6"},
79:{ingredient:"Человеческое сердце", effects:["Урон здоровью", "Урон магии", "Повреждение регенерации магии", "Бешенство"], weight:"1", price:"0"},
80:{ingredient:"Человечье мясо", effects:["Урон здоровью", "Паралич", "Восстановление магии", "Повышение навыка: Скрытность"], weight:"0.25", price:"1"},
81:{ingredient:"Чеснок", effects:["Сопротивление ядам", "Повышение запаса сил", "Регенерация магии", "Регенерация здоровья"], weight:"0.25", price:"1"},
82:{ingredient:"Чешуйчатка", effects:["Уязвимость к магии", "Повышение навыка: Иллюзия", "Регенерация запаса сил", "Повышение переносимого веса"], weight:"0.25", price:"4"},
83:{ingredient:"Чешуя рыбы-убийцы", effects:["Сопротивление холоду", "Затяжной урон здоровью", "Повышение навыка: Тяжелая броня", "Повышение навыка: Блокирование"], weight:"0.1", price:"3"},
84:{ingredient:"Эктоплазма", effects:["Восстановление магии", "Повышение навыка: Разрушение", "Повышение магии", "Урон здоровью"], weight:"0.1", price:"25"},
85:{ingredient:"Эльфийское ухо", effects:["Восстановление магии", "Повышение искусства лучника", "Уязвимость к холоду", "Сопротивление огню"], weight:"0.1", price:"10"},
86:{ingredient:"Ягоды можжевельника", effects:["Уязвимость к огню", "Повышение искусства лучника", "Регенерация здоровья", "Повреждение регенерации запаса сил"], weight:"0.1", price:"1"},
87:{ingredient:"Ядовитый колокольчик", effects:["Урон здоровью", "Опустошение запаса сил", "Замедление", "Уязвимость к яду"], weight:"0.1", price:"4"},
88:{ingredient:"Язык дракона", effects:["Сопротивление огню", "Повышение искусства торговли", "Повышение навыка: Иллюзия", "Повышение навыка: Двуручное оружие"], weight:"0.1", price:"5"},
89:{ingredient:"Яйцо коруса", effects:["Уязвимость к яду", "Повышение запаса сил", "Урон магии", "Невидимость"], weight:"0.2", price:"10"},
90:{ingredient:"Яйцо оригмы", effects:["Восстановление здоровья", "Повышение навыка: Одноручное оружие", "Урон запасу сил", "Уязвимость к магии"], weight:"0.5", price:"2"},
91:{ingredient:"Яйцо соснового дрозда", effects:["Восстановление запаса сил", "Повышение навыка: Взлом", "Уязвимость к яду", "Сопротивление электричеству"], weight:"0.5", price:"2"},
// The Elder Scrolls V: Dawnguard
92:{ingredient:"Жёлтый горноцвет (DG)", effects:["Сопротивление ядам", "Повышение здоровья", "Повышение навыка: Восстановление", "Повреждение регенерации запаса сил"], weight:"0.1", price:"2"},
93:{ingredient:"Крыло мотылька предка (DG)", effects:["Урон запасу сил", "Повышение навыка: Колдовство", "Повреждение регенерации магии", "Повышение навыка: Зачарование"], weight:"0.1", price:"2"},
94:{ingredient:"Светящийся цветок (DG)", effects:["Сопротивление магии", "Страх", "Регенерация здоровья", "Паралич"], weight:"0.1", price:"5"},
95:{ingredient:"Усик коруса-охотника (DG)", effects:["Урон запасу сил", "Повышение навыка: Колдовство", "Повреждение регенерации магии", "Повышение навыка: Зачарование"], weight:"0.1", price:"2"},
96:{ingredient:"Ядовитый цветок (DG)", effects:["Урон здоровью", "Страх", "Повышение переносимого веса", "Замедление"], weight:"0.1", price:"5"},
// The Elder Scrolls V: Hearthfire
97:{ingredient:"Лососёвая икра (HF)", effects:["Водное дыхание", "Повышение магии", "Регенерация магии", "Восстановление запаса сил"], weight:"0.2", price:"5"},
98:{ingredient:"Яйцо ястреба (HF)", effects:["Сопротивление магии", "Водное дыхание", "Повреждение регенерации магии", "Затяжной урон запасу сил"], weight:"0.5", price:"5"},
// The Elder Scrolls V: Dragonborn
99:{ingredient:"Вредозобник (D)", effects:["Опустошение здоровья", "Опустошение запаса сил", "Опустошение магии", "Затяжной урон здоровью"], weight:"0.1", price:"1"},
100:{ingredient:"Древесина горелого сприггана (D)", effects:["Уязвимость к огню", "Повышение навыка: Изменение", "Повреждение регенерации магии", "Замедление"], weight:"0.5", price:"20"},
101:{ingredient:"Желе нетча (D)", effects:["Паралич", "Повышение переносимого веса", "Восстановление запаса сил", "Страх"], weight:"0.5", price:"20"},
102:{ingredient:"Желе пепельного прыгуна (D)", effects:["Восстановление здоровья", "Повышение навыка: Легкая броня", "Сопротивление электричеству", "Уязвимость к холоду"], weight:"0.25", price:"20"},
103:{ingredient:"Императорский зонтичный мох (D)", effects:["Урон здоровью", "Повышение магии", "Регенерация здоровья", "Повышение навыка: Двуручное оружие"], weight:"0.25", price:"1"},
104:{ingredient:"Кабаний клык (D)", effects:["Повышение запаса сил", "Повышение здоровья", "Повышение навыка: Блокирование", "Бешенство"], weight:"0.5", price:"20"},
105:{ingredient:"Корень трамы (D)", effects:["Уязвимость к электричеству", "Повышение переносимого веса", "Урон магии", "Замедление"], weight:"0.2", price:"1"},
106:{ingredient:"Пепел порождения (D)", effects:["Опустошение запаса сил", "Сопротивление огню", "Повышение навыка: Зачарование", "Опустошение магии"], weight:"0.1", price:"20"},
107:{ingredient:"Пепельная ползучая лоза (D)", effects:["Урон запасу сил", "Невидимость", "Сопротивление огню", "Повышение навыка: Разрушение"], weight:"0.25", price:"20"},
108:{ingredient:"Перья фельсадской крачки (D)", effects:["Восстановление здоровья", "Повышение навыка: Легкая броня", "Исцеление болезней", "Сопротивление магии"], weight:"0.1", price:"15"},
109:{ingredient:"Стручок пепельной травы (D)", effects:["Сопротивление огню", "Уязвимость к электричеству", "Повышение навыка: Взлом", "Повышение навыка: Скрытность"], weight:"0.1", price:"1"},
//regex ^([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)\t([^\t]+)
//:{ingredient:"\2", effects:["\4", "\5", "\6", "\7"], weight:"0.1", price:"2"},
};

function prepareingredientsList() {
	var str='';
	$("table#ingredients_table tbody tr").each(function(_i, tr) {
		var id = getRowId(tr);
		var i = ingredientsList[id];
		str += id+':{ingredient:"'+i.ingredient+'", effects:["'+i.effects[0]+'", "'+i.effects[1]+'", "'+i.effects[2]+'", "'+i.effects[3]+'"], weight:"'+i.weight+'", price:"'+i.price+'"},<br>';
	});
	$('#loading').html(str);
	$("#loading").show();
	$("#alch_div").hide();
}
</script>

<script type="text/javascript">
// concat two arrays
// x = in both arrays values
// or = only in one array values
function getXorArray(arr1, arr2) {
	var xArr = new Array();
	var orArr = arr1.concat(arr2).sort();
	for (var i=0; i < orArr.length; ) {
		if(orArr[i] == orArr[i+1]) {
			xArr.push(orArr[i]);
			var k = 2;
			for (var j=i+2; j < orArr.length && orArr[i] == orArr[j]; j++) k++;
			orArr.splice(i, k);
		} else {
			i++;
		}
	}
	return {x:xArr, or:orArr};
}

// prepare potion
function makeMixing(effects1, effects2) {
	var mix = getXorArray(effects1, effects2);
	var price = calcEPrice(mix.x);
	return {price:price, effects:mix.x, unused:mix.or};
}

// potion key
function makeMixKey(id2, id3) {
	return id2 < id3 ? ''+id2+'+'+id3 : ''+id3+'+'+id2;
}

// investigate all potions with selected ingredient
function makeIngredientBestPrice(id, includeFiltered) {
	var priceById = {};
	var mixList = {};
	var mixListFull = {};
	// get the list of second ingredients with same effects
	var effects1 = ingredientsList[id].effects;
	var ingredients2 = Array();
	for (var i=0; i<effects1.length; i++) {
		ingredients2 = ingredients2.concat( ingredientsByEffect[ effects1[i] ] );
	}
	// loop in second ingredients
	ingredients2.sort();
	for (var i2=0; i2<ingredients2.length; i2++) {
		var id2 = ingredients2[i2];
		// filter first, doubled and filtered
		if (id2 != id && id2 != ingredients2[i2+1] && (includeFiltered || !isFilteredIngredient(id2))) {
			var potion2 = makeMixing(effects1, ingredientsList[id2].effects);
			// get the list of third ingredients with unused effects
			var effects2 = potion2.unused;
			var ingredients3 = Array();
			for (var i=0; i<effects2.length; i++) {
				ingredients3 = ingredients3.concat( ingredientsByEffect[ effects2[i] ] );
			}
			// loop in third ingredients
			var bestPrice2 = 0;
			ingredients3.sort();
			for (var i3=0; i3<ingredients3.length; i3++) {
				var id3 = ingredients3[i3];
				// filter first, second, doubled and filtered
				if (id3 != id && id3 != id2 && id3 != ingredients3[i3+1] && (includeFiltered || !isFilteredIngredient(id3))) {
					var potion3 = makeMixing(effects2, ingredientsList[id3].effects);
					// var finPrice = potion2.price + potion3.price; wrong!
					var finPrice = calcEPrice( potion2.effects.concat(potion3.effects) );
					// final check
					if (bestPrice2 < finPrice) {
						bestPrice2 = finPrice;
					}
					// to list
					if (mixList[finPrice] == undefined)
						mixList[finPrice] = {};
					mixList[finPrice][makeMixKey(id2,id3)] = {id2:id2, id3:id3};
				}
			}
			priceById[id2] = bestPrice2;
		}
	}
	// sorting
	var listKeys = Object.keys(mixList).sort(function(a,b){return b-a;});
	return {price:listKeys[0], list:mixList, listKeys:listKeys, priceById:priceById};
}

// prepare a title
function makeMixTitle(mixes) {
	var title = '';
	for (var i in mixes) {
		title += (title!=''?' &nbsp;|&nbsp; ':'') + ingredientsList[mixes[i].id2].ingredient+' + '+ingredientsList[mixes[i].id3].ingredient;
	}
	return title;
}
</script>

<script type="text/javascript">
	var idByIngredient = {};
	var ingredientsByEffect = {};
	for (var i in effectsPrice)
		ingredientsByEffect[i] = new Array();
	var currentIngredient = null;
	var currentIngredient2 = null;
	var potionsIsFull = false;
	var potionsId = 0;
	var potionsHistory = Array();


	function getRowId(e) {
		return parseInt($(e).attr('origindex'));
	}

	function getRowById(id) {
		return $("table#ingredients_table tbody tr[origindex="+id+"]");
	}

	function getEffectsFromRow(e) {
		return ingredientsList[getRowId(e)].effects.slice(0); //clone
	}

	function clearActiveIngredients() {
		if (currentIngredient != null) {
			getRowById(currentIngredient).removeClass('unusable');
			currentIngredient = null;
		}
		if (currentIngredient2 != null) {
			getRowById(currentIngredient2).removeClass('unusable');
			currentIngredient2 = null;
		}
		$('#ingredient_filter table tbody').children().remove();
	}

	function clickIngredientFilter(e) {
		clearActiveIngredients();
		clickIngredient(e);
	}

	function clickIngredient(e) {
		var id = e.data;
		var tr = getRowById(id);
		var ingredient = ingredientsList[id];
		var effects = ingredient.effects;
		var dubEffects = new Array();
		var curPrice = 0;
		
		if (currentIngredient != null) {
			effects = effects.concat(ingredientsList[currentIngredient].effects).sort();
			for (var i=0; i<effects.length;) {
				if(effects[i] == effects[i+1]) {
					curPrice += effectsPrice[effects[i]];
					dubEffects.push(effects[i]);
					effects.splice(i, 2);
				} else {
					i++;
				}
			}
			currentIngredient2 = id;
		} else {
			currentIngredient = id;
		}

		// clear
		$("#ingredient_filter tbody tr a").removeClass('highlighted');
		$("table#ingredients_table tbody tr a").removeClass('highlighted');

		// update filter
		watchRow = tr.clone(true);
		$(watchRow).find('td:first a img').parent().remove();
		var $childrens = $('#ingredient_filter table tbody').children();
		if ($childrens.size() > 1)
			$childrens.last().remove();
		$(watchRow).find('td:eq(5)').html(ingredient.weight);
		$(watchRow).find('td:eq(6)').html(ingredient.price);
		$('#ingredient_filter table tbody').append(watchRow);
		
		if (dubEffects.length > 0) {
			$("#ingredient_filter tbody td>a").each(function(i, checkA) {
				var effect = $(checkA).html();
				if ($.inArray(effect, dubEffects) > -1) {
					$(checkA).addClass('highlighted');
				}
			});
		}
		
		var eye = $('<div class="diveye"><a><img src="./files/ico_eye.png" /></a></div>').click(id, clickIngredientFilter);
		$('#ingredient_filter table tbody tr:last td:first').append(eye);

		// update main table
		$("table#ingredients_table tbody tr").each(function(i, checkRow) {
			var id = getRowId(checkRow);
			if (id == currentIngredient)
				return;
			var ingredient = ingredientsList[id];
			var rowEffects = ingredient.effects;
			var show = 0;
			var price = curPrice;
			for (var i in rowEffects) {
				for (var j in effects) {
					if (rowEffects[i] == effects[j]) {
						show++;
						price += effectsPrice[rowEffects[i]];
						$(checkRow).find("a:contains('" + rowEffects[i] + "')").addClass('highlighted');
					}
				}
			}
			if (show>0) {
				$(checkRow).removeClass('unusable');
				if (show>1) {
					$(checkRow).find(".name_column a").addClass('highlighted');
				}
				//price
				if (currentIngredient2 == null) {
					$(checkRow).find("td:eq(5)").html(price);
					var priceById = ingredient.best.priceById[currentIngredient];
					var title = makeMixTitle(ingredient.best.list[priceById]);
					$(checkRow).find("td:eq(6)").html('<a title="'+title+'">'+(priceById?priceById:price)+'</a>');
				} else {
					$(checkRow).find("td:eq(5)").html(ingredient.weight);
					$(checkRow).find("td:eq(6)").html(price);
				}
			} else {
				$(checkRow).addClass('unusable');
			}
		});
		$("#ingredients_table").trigger("update");
		window.setTimeout( function() {
			$("#ingredients_table").trigger("sorton", [[[6,1]]]);
		}, 100);
		
		$('#all_ingredients').hide();
		$('#effects_filter').hide();
		$('#ingredient_filter').show();

		if (currentIngredient != null)
			getRowById(currentIngredient).addClass('unusable');
		tr.addClass('unusable');
		
		window.scrollTo(0,$('#filter_div').position().top+15);
		return false;
	}

	function clickEffect(e) {
		$("table#ingredients_table tbody tr a").removeClass('highlighted');
		td = $(this).parent();
		effect = td.find('a').text().trim();

		$("table#ingredients_table tbody tr").each(function(i, checkRow) {
			var rowEffects = getEffectsFromRow(checkRow);
			var show = false;
			if ($.inArray(effect, rowEffects) > -1) {
				show = true;
				$(checkRow).find("a:contains('" + effect + "')").each(function(i, e) {
					$(e).addClass('highlighted');
				});
			}
			if (!show) {
				$(checkRow).addClass('unusable');
			} else {
				$(checkRow).removeClass('unusable');
			}
		});
		
		$("#effect_name").text(effect);
		
		$('#all_ingredients').hide();
		$('#ingredient_filter').hide();
		$('#effects_filter').show();
		currentIngredient = null;
		$('#ingredient_filter table tbody').children().remove();
		
		window.scrollTo(0,$('#filter_div').position().top+15);
		return false;
	}
	
	function showAll() {
		$('#all_ingredients').show();
		$('#ingredient_filter').hide();
		$('#effects_filter').hide();
		$("table#ingredients_table tbody tr a").removeClass('highlighted');
		$("table#ingredients_table tbody tr").removeClass('unusable');
		currentIngredient = null;
		$('#ingredient_filter table tbody').children().remove();
		return false;
	}

	
	// ==================================================================================================================
	// Filter UI functions
	
	function showFiltered() {
		var filtered = '';
		for (var ingredient in idByIngredient) {
			var id = idByIngredient[ingredient];
			filtered += '<div class="filterBox"><label><input type="checkbox" name="fi_'+id+'" title="'+id+'" value="'+id+'"'+(isFilteredIngredient(id)?' checked':'')+' onclick="editFilterCheckboxClick(this)"/>'+ingredient+'</label></div>';
		}
		$('#filtered_div table tbody td:first').html(filtered);
		$('#filtered_show_div').hide();
		$('#filtered_div').show();
		
		// add checkboxes into others tables
		$('#ingredient_name_div').addClass('EditFilterMode');
		$('#ingredient_name_div tbody tr').each(function(i, tr) {
			var $td1 = $(tr).find('td:first');
			var id = getRowId(tr);
			$td1.prepend('<input type="checkbox" name="fi_'+id+'" title="'+id+'" value="'+id+'"'+(isFilteredIngredient(id)?' checked':'')+' onclick="editFilterCheckboxClick(this)"/>');
		});
		$('#ingredient_filter').addClass('EditFilterMode');
		$('#ingredient_filter tbody tr').each(function(i, tr) {
			var $td1 = $(tr).find('td:first');
			var id = getRowId(tr);
			$td1.prepend('<input type="checkbox" name="fi_'+id+'" title="'+id+'" value="'+id+'"'+(isFilteredIngredient(id)?' checked':'')+' onclick="editFilterCheckboxClick(this)"/>');
		});
		$('#ingredients_table_div').addClass('EditFilterMode');
		$('#ingredients_table_div tbody tr').each(function(i, tr) {
			var $td1 = $(tr).find('td:first');
			var id = getRowId(tr);
			$td1.prepend('<input type="checkbox" name="fi_'+id+'" title="'+id+'" value="'+id+'"'+(isFilteredIngredient(id)?' checked':'')+' onclick="editFilterCheckboxClick(this)"/>');
		});
		
		return false;
	}

	function editFilterCheckboxClick(e) {
		var id = e.value;
		var checked = e.checked;
		$('#filtered_div table tbody td input[name=fi_'+id+']').prop('checked', checked);
		$('#ingredient_name_div table tbody td input[name=fi_'+id+']').prop('checked', checked);
		$('#ingredient_filter table tbody td input[name=fi_'+id+']').prop('checked', checked);
		$('#ingredients_table_div table tbody td input[name=fi_'+id+']').prop('checked', checked);
	}

	function toggleAllFiltered() {
		if ($('#all_filtered').attr('checked') == undefined) {
			$('#filtered_div table tbody input[type=checkbox]').removeAttr('checked');
		} else {
			$('#filtered_div table tbody input[type=checkbox]').prop('checked', true);
		}
		return false;
	}

	function applyFiltered() {
		// update array
		filteredIngredients = Array();
		$("#filtered_div table input:checked").each(function(i, e) {
			filteredIngredients.push(parseInt($(e).val()));
		});

		// culc best price
		for (var i in ingredientsList) {
			ingredientsList[i].best = makeIngredientBestPrice(i, false);
		}

		// update table
		$("table#ingredients_table tbody tr").each(function(i, tr) {
			var $td1 = $(tr).find('td:first');
			if (isFilteredIngredient(getRowId(tr))) {
				$td1.addClass('filtered');
			} else {
				$td1.removeClass('filtered');
			}
			//best price
			var best = ingredientsList[getRowId(tr)].best;
			$(tr).find('td:eq(7)').html('<a title="'+makeMixTitle(best.list[best.price])+'">'+(best.price ? best.price : '-')+'</a>');
		});
		$("#ingredients_table").trigger("update");
		window.setTimeout( function() {
			$("#ingredients_table").trigger("sorton", [$("#ingredients_table").get(0).config.sortList]);
		}, 100);

		// save & close
		saveFiltered();
		refreshPotions();
		toggleFilteredRows();
		closeFiltered();
		return false;
	}

	function closeFiltered() {
		$('#ingredient_name_div input[type=checkbox]').remove();
		$('#ingredient_name_div').removeClass('EditFilterMode');
		$('#ingredient_filter input[type=checkbox]').remove();
		$('#ingredient_filter').removeClass('EditFilterMode');
		$('#ingredients_table_div input[type=checkbox]').remove();
		$('#ingredients_table_div').removeClass('EditFilterMode');
		$('#filtered_div').hide();
		$('#filtered_show_div').show();
		return false;
	}

	function toggleFilteredRows() {
		$("table#ingredients_table tbody tr.filtered").removeClass('filtered');
		if ($('#show_filtered').prop('checked') == false) {
			$("table#ingredients_table tbody tr").each(function(i, tr) {
				if (isFilteredIngredient(getRowId(tr))) {
					$(tr).addClass('filtered');
				}
			});
		}
		return false;
	}

	function saveFiltered() {
		if (!supportsLocalStorage()) return;
		var data;
		try{ data = localStorage.getItem('skyrim_alchemy_tool'); }catch(e){}
		try{ data = JSON.parse(data); }catch(e){}
		if (!data || !data.saves) data = {saves:{}};
		var key = '1';
		data.lastKey = key;
		data.saves[data.lastKey] = filteredIngredients;
		try{ localStorage.setItem('skyrim_alchemy_tool', JSON.stringify(data)); }catch(e){}
	}

	function loadFiltered() {
		if (!supportsLocalStorage()) return;
		var data;
		try{ data = localStorage.getItem('skyrim_alchemy_tool'); }catch(e){}
		try{ data = JSON.parse(data); }catch(e){}
		if (!data || !data.saves)
			return;
		filteredIngredients = data.saves[data.lastKey];
	}

	// localStorage detection
	function supportsLocalStorage() {
		return typeof(localStorage)!== 'undefined' && typeof(JSON)!== 'undefined';
	}


	// ==================================================================================================================
	// Potions list functions
	
	function showPotions(e) {
		var priceDelta = 150;
		var lowPriotityDelta = 200;
		var id = !e || !e.data || e.data.id == undefined ? potionsId : e.data.id;
		var isFull = !e || !e.data || e.data.isFull == undefined ? potionsIsFull : e.data.isFull ? true : false;
		var ingredient = ingredientsList[id];
		var best = isFull ? ingredient.bestFull : ingredient.best;

		// history and buttons
		if (id != potionsId)
			potionsHistory.push(id);
		potionsId = id;
		potionsIsFull = isFull;
		$('#potions_div input.aback').prop('disabled', (potionsHistory.length < 2));
		$('#potions_div input.afull').val(isFull ? 'Применить фильтр' : 'Показать все варианты');
		$('#potions_div img.hd_ico').attr('src', isFull ? './files/ico_price_b.png' : './files/ico_price.png');

		// name
		$('#potions_div .base_ingredient_name').html(ingredient.ingredient);

		// list
		var $tbody = $('#potions_div table tbody');
		$tbody.children().remove();
		for (var i in best.listKeys) {
			var price = best.listKeys[i];
			var mixes = best.list[price];
			// makeMixTitle
			var title = '';
			for (var k in mixes) {
				title += (title!=''?' &nbsp;|&nbsp; ':'');
				var ingr = ingredientsList[mixes[k].id2];
				var best0 = isFull ? ingr.bestFull : ingr.best;
				var price0 = parseInt(best0.price)
				var color = price0 > price ? (price0 > parseInt(price) + priceDelta ? 'color:#AA0000' : 'color:#AA7A0A') : (price0 == price ? 'color:#008000' : '');
				title += '<a title="'+price0+'" onclick="showPotions({data:{id:'+mixes[k].id2+'}})" style="'+color+'">'+ingr.ingredient+'</a>';
				title += ' + ';
				var ingr = ingredientsList[mixes[k].id3];
				var best0 = isFull ? ingr.bestFull : ingr.best;
				var price0 = parseInt(best0.price)
				var color = price0 > price ? (price0 > parseInt(price) + priceDelta ? 'color:#AA0000' : 'color:#AA7A0A') : (price0 == price ? 'color:#008000' : '');
				title += '<a title="'+price0+'" onclick="showPotions({data:{id:'+mixes[k].id3+'}})" style="'+color+'">'+ingr.ingredient+'</a>';
			}
			$tbody.append('<tr' + (price < lowPriotityDelta ? ' class="lowprio"' : '') + '><td>' + price + '</td><td>' + title + '</td></tr>');
		}

		// more potions
		if ($tbody.children().size() > 5) {
			var $tr_for_more = $tbody.find('tr.lowprio:gt(3)');
			if ($tr_for_more.size()) {
				$tbody.append('<tr class="showmore"><td></td><td class="pointer" onclick="showMorePotions()"><a>показать еще...</a></td></tr>');
				$tr_for_more.hide();
			}
		}

		// ingredient
		$('#ingredient_name_div table tbody').children().remove();
		$('#ingredient_name_div table tbody').append(getRowById(id).clone(true).show());

		$('#potions_div').show();
		window.scrollTo(0,0);
		return false;
	}

	function showMorePotions() {
		var $tbody = $('#potions_div table tbody');
		$tbody.children().show();
		$tbody.find('.showmore').hide();
	}

	function prevPotions() {
		potionsHistory.pop();
		var id = potionsHistory.pop();
		if (id)
			showPotions({data:{id:id}});
	}

	function refreshPotions() {
		if ($('#potions_div').css('display') != 'none')
			// showPotions({data:{id:potionsId}});
			showPotions();
	}


	// ==================================================================================================================
	// loading functions
	
	function initAll() {
		$("#alch_div").hide().after('<div id="loading"><div id="progress_bar">loading...</div></div>');
		var iterator = initIterator();
		var iterator_step = function() {
			var v = iterator.next();
			console.log(v); // { value:%, done:false/true }
			if (!v.done) {
				$("#progress_bar").html(v.value+'%').css('width',v.value+'%');
				window.setTimeout(iterator_step, 10);
			} else {
				$("#loading").hide();
				$("#alch_div").show();
			}
		}
		window.setTimeout(iterator_step, 10);
	}

	function* initIterator() {
		// load filtered
		loadFiltered();
		yield 2;

		// prepare hashmap
		for (var id in ingredientsList) {
			var ingredient = ingredientsList[id];
			for (var l=0; l<4; l++) {
				var effect = ingredient.effects[l];
				if (ingredientsByEffect[effect] == undefined)
					alert(effect+' - undefined!');
				else
					ingredientsByEffect[effect].push(id);
			}
		}
		yield 4;

		// id by ingredient
		var ing2id = {};
		for (var i in ingredientsList) {
			ing2id[ingredientsList[i].ingredient] = i;
		}
		var ingKeys = Object.keys(ing2id).sort();
		for (var i in ingKeys) {
			idByIngredient[ingKeys[i]] = ing2id[ingKeys[i]];
		}
		yield 6;

		// culc best price
		var cnt = Object.keys(ingredientsList).length;
		var k = 0;
		for (var i in ingredientsList) {
			ingredientsList[i].best = makeIngredientBestPrice(i, false);
			ingredientsList[i].bestFull = makeIngredientBestPrice(i, true);
			k++;
			yield 6+Math.round(90*k/cnt);
		}
		//yield 96;

		// prepare ingredients table
		var $ingredients_tbody = $("table#ingredients_table tbody");
		$ingredients_tbody.children().remove();
		for (var id in ingredientsList) {
			var ingredient = ingredientsList[id];
			var $tr = $('<tr origindex="'+id+'"></tr>');
			// name
			var $td1 = $('<td class="name_column"></td>');
			$td1.append($('<a title="'+ingredient.ingredient+'">'+ingredient.ingredient+'</a>').click({id:id}, showPotions));
			// eye
			$td1.append($('<div class="diveye"><a title="'+id+'"><img src="./files/ico_eye.png" /></a></div>').click(id, clickIngredient));
			// filtered
			if (isFilteredIngredient(id))
				$td1.addClass('filtered');
			$tr.append($td1);
			// effects
			for (var k=0; k<4; k++) {
				var effect = ingredient.effects[k];
				var price = effectsPrice[effect];
				var title = price ? effect+' | '+price : effect;
				var $td = $('<td class="'+(effectsPositive[effect]?'EffectPos':'EffectNeg')+'"><a title="'+title+'">'+effect+'</a></td>');
				// price bar
				$td.append('<div class="effectvprice" title="'+price+'" style="height:'+Math.ceil(price/maxEPrice*33)+'px"></div>');
				// eye
				$td.append($('<div class="diveye"><a><img src="./files/ico_eye.png" /></a></div>').click(clickEffect));
				// warning
				if ($.inArray(effect, effectsWarning) > -1)
					$td.addClass('effect_warning');
				$tr.append($td);
			}
			// weight,price
			$tr.append('<td>'+ingredient.weight+'</td><td>'+ingredient.price+'</td>');
			//best price
			var best = ingredient.best;
			$tr.append($('<td class="best_price"><a title="'+makeMixTitle(best.list[best.price])+'">'+(best.price?best.price:'-')+'</a></td>').click({id:id, isFull:false}, showPotions));
			var bestFull = ingredient.bestFull;
			if (bestFull) {
				$tr.append($('<td class="best_price"><a title="'+makeMixTitle(bestFull.list[bestFull.price])+'">'+bestFull.price+'</a></td>').click({id:id, isFull:true}, showPotions));
			}
			// insert into table
			$ingredients_tbody.append($tr);
		}
		yield 98;

		// table header
		var $ingredients_header = $('table#ingredients_table thead tr');
		$('#ingredient_name_div table thead').append($ingredients_header.clone());
		$('#ingredient_filter table thead').append($ingredients_header.clone());

		// make sortable
		$("#ingredients_table").tablesorter({sortList: [[0,0]] });
		yield 99;

		// Filter
		toggleFilteredRows();
		yield 100;
	}

	// onload
	$(document).ready(function() {
		initAll();
	});
</script>
</head>
<body>

<div id="pagemain">
	<div id="wrapper">
		<div id="maincolumn" class="mainstyles">
			<div class="maincontent">

<div id="help_info" style="display:none">
	<div style="float:right; padding:3px 10px"><a onclick="$('#help_info').hide();return false;">(Скрыть)</a></div>
	<h3>Приветствую тебя, алхимик</h3>
	<ul>
		<li><b>Нажми на название ингредиента</b> чтобы увидеть список рецептов с этим ингредиентом.</li>
		<li><b>Используй фильтр</b> чтобы ограничить использование ингредиентов для составления списка рецептов.</li>
		<li><b>Нажми на глаз рядом с названием ингредиента</b> чтобы увидеть только те ингредиенты которые имеют общие с данным ингредиентом эффекты.</li>
		<li><b>Нажми на глаз рядом с названием эффекта</b> чтобы увидеть только те ингредиенты которые содержат выбранный эффект.</li>
		<li><b>Нажми на заголовок таблицы</b> чтобы отсортировать содержимое.</li>
	</ul>
	<p style="margin-top:20px; padding-left:20px">
		<b>Значения колонок:</b>
	</p>
	<ul style="list-style-type: none;">
		<li><img alt="Weight" src="./files/ico_weight.png"> - Вес / Промежуточная цена зелья при выбранном ингредиенте<br></li>
		<li><img alt="Value" src="./files/ico_gold.png" /> - Цена / Условная цена лучшего рецепта для выбранного ингредиента<br></li>
		<li><img alt="Best" src="./files/ico_price.png" /> - Условная цена лучшего рецепта из отфильтрованных<br></li>
		<li><img alt="Best" src="./files/ico_price_b.png" /> - Условная цена лучшего рецепта из всех ингредиентов<br></li>
	</ul>
</div>

<div id="alch_div">
	<div style="float:right; padding:3px 10px"><a onclick="$('#help_info').toggle();return false;" style="color:#E8F4F9">(Подсказка)</a></div>

<div id="filtered_show_div">
	<p><input class="abutton" type="submit" value="Фильтр" onclick="showFiltered();"></p>
</div>
<div id="filtered_div" style="display:none">
	<p><input class="abutton" type="submit" value="Отмена" onclick="closeFiltered();"> <input class="abutton" type="submit" value="Принять" onclick="applyFiltered();"></p>
	<p>Исключенные ингредиенты. <label><input type="checkbox" id="all_filtered" onclick="toggleAllFiltered();"/> отметить все.</label></p>
	<table>
		<tbody>
			<tr>
				<td>
				</td>
			</tr>
		</tbody>
	</table>
</div>

<div id="potions_div" style="display:none">
	<div id="ingredient_name_div" style="margin-top: 15px;">
		<table>
			<thead></thead>
			<tbody></tbody>
		</table>
	</div>
	<p><input class="abutton aback" type="submit" value="&lt; Назад" onclick="prevPotions();"> <input class="abutton afull" type="submit" value="Показать" onclick="showPotions({data:{isFull:!potionsIsFull}});"> <input class="abutton" type="submit" value="Закрыть" onclick="$('#potions_div').hide();"></p>
	<table>
		<thead>
			<tr>
				<th class="num_column"><img class="hd_ico" alt="Best" src="./files/ico_price.png"></th>
				<th class="ingredients_column">Рецепты на основе ингредиента: <i class="base_ingredient_name"></i></th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
	<p><input class="abutton aback" type="submit" value="&lt; Назад" onclick="prevPotions();"> <input class="abutton afull" type="submit" value="Показать" onclick="showPotions({data:{isFull:!potionsIsFull}});"> <input class="abutton" type="submit" value="Закрыть" onclick="$('#potions_div').hide();"></p>
</div>

<div id="filter_div">
	<div id="all_ingredients" style="display: block;">
		<p>Показаны все ингредиенты.</p>
	</div>
	
	<div id="ingredient_filter" style="display: none;">
		<p>Показаны только те ингредиенты, которые имеют общие эффекты с:</p>
		<table>
			<thead></thead>
			<tbody></tbody>
		</table>
		<p>Совпавшие эффекты выделены <span class="highlighted">жирным</span></p>
		<input class="abutton" type="submit" value="Показать все" onclick="showAll();">	
	</div>
	
	<div id="effects_filter" style="display: none;">
		<p>Показаны ингредиенты которые имеют эффект <a id="effect_name" class="highlighted" onclick="return false;">Повреждение регенерации запаса сил</a></p>
		<input class="abutton" type="submit" value="Показать все" onclick="showAll();"> 
	</div>	
</div>

<div style="float:right; padding:3px 10px; height: 0px; position: relative; top: -30px;"><label><input type="checkbox" id="show_filtered" onclick="toggleFilteredRows();">Отображать отфильтрованные.</label></div>
<div id="ingredients_table_div">
<table class="tablesorter" id="ingredients_table">
	<thead>
		<tr>
			<th class="name_column">Название</th>
			<th class="effect_column">Первый эффект</th>
			<th class="effect_column">Второй эффект</th>
			<th class="effect_column">Третий эффект</th>
			<th class="effect_column">Четвертый эффект</th>
			<th class="num_column"><img alt="Weight" src="./files/ico_weight.png" /></th>
			<th class="num_column"><img alt="Value" src="./files/ico_gold.png" /></th>
			<th class="num_column"><img alt="Best" src="./files/ico_price.png" /></th>
			<th class="num_column"><img alt="Best" src="./files/ico_price_b.png" /></th>
		</tr>
	</thead>
	<tbody></tbody>
</table>
</div>

</div>

			</div>
		</div>
	</div>
</div>

</body>
</html>